ipcrm/puppet_webapp:
  Env:
    - PORT: "8080"
  PreBuild:
    - git clone https://github.com/pyenv/pyenv.git ~/.pyenv
    - export PYENV_ROOT="$HOME/.pyenv"
    - export PATH="$PYENV_ROOT/bin:$PATH"
    - eval "$(pyenv init -)"
    - pyenv install 2.7.10
    - pyenv install 3.5.0
    - pyenv local 2.7.10 3.5.0
    - pip3.5 install tox
  Build:
    - export PYENV_ROOT="$HOME/.pyenv"
    - export PATH="$PYENV_ROOT/bin:$PATH"
    - eval "$(pyenv init -)"
    - pyenv local 2.7.10 3.5.0
    - tox
    - python ./setup.py sdist
  PkgInclude:
    - 'dist/*.tar.gz'
  PreInstall:
    - sudo yum install -y python-pip python-virtualenv gcc gcc-c++
    - test -d ~/virtualenv || mkdir ~/virtualenv
    - test -d ~/virtualenv/puppet_webapp && rm -rf ~/virtualenv/puppet_webapp
    - virtualenv ~/virtualenv/puppet_webapp
  PostInstall:
    - source ~/virtualenv/puppet_webapp/bin/activate
    - pip install dist/*
    - pip install gunicorn
  Exec:
    - source ~/virtualenv/puppet_webapp/bin/activate
    - gunicorn --workers=2 webui:webui -b 0.0.0.0:$PORT
  PostStart:
    - sudo iptables -A INPUT -p tcp -m multiport --dports $PORT -m comment --comment "110 allow http ${PORT} access" -j ACCEPT
