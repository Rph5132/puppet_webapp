ipcrm/puppet_webapp:
  PreBuild:
    - git clone https://github.com/pyenv/pyenv.git ~/.pyenv
    - export PYENV_ROOT="$HOME/.pyenv"
    - export PATH="$PYENV_ROOT/bin:$PATH"
    - eval "$(pyenv init -)"
    - pyenv install 2.7.10
    - pyenv local 2.7.10
    - pip install -r requirements.txt
    - pip install discover
    - python ./test.py -v
  Build:
    - python ./setup.py sdist
  PkgInclude:
    - 'dist/*.tar.gz'
  AfterBuildSuccess:
    - echo "Build Success"
    - echo "Creating github release"
    - API_JSON=$(printf '{"tag_name":"%s","target_commitish":"%s","name":"%s","body":"Release of version %s","draft":false,"prerelease":false}' $DISTELLI_BUILDNUM $DISTELLI_RELBRANCH $DISTELLI_BUILDNUM $DISTELLI_BUILDNUM)
    - curl -s -f -k -X POST -H "Content-Type: application/json" "https://api.github.com/repos/$GITHUB_USERNAME/$GITHUB_APPNAME/releases?access_token=$GITHUB_TOKEN" -d "$API_JSON"
    - ARCHIVE=$(find . -name '*.tar.gz')
    - GH_ASSET="https://uploads.github.com/repos/${GITHUB_USERNAME}/${GITHUB_APPNAME}/releases/${DISTELLI_BUILDNUM}/assets?name=$(basename ${ARCHIVE})"
    - curl -d @$ARCHIVE -H "Authorization\: token ${GITHUB_TOKEN}" -H "Content-Type\: application/octent-stream" $GH_ASSET

